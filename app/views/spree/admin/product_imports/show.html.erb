<% content_for :page_title do %>
    <%= Spree.t(:review) + ' ' + Spree.t(:product_import) %>
<% end %>

<div id="results"></div>

<script type="text/javascript">
  function update_row(item) {
    $('#product_import_data tr[data-product-import-id="'+item.id+'"] td.product_id').html(item.product_id);
    $('#product_import_data tr[data-product-import-id="'+item.id+'"] td.state span').html('imported').removeClass('label-warning').addClass('label-success');
    $('#product_import_data tr[data-product-import-id="'+item.id+'"] td.publish_state span').html(item.publish_state);
    if (item.publish_state == 'published') {
      $('#product_import_data tr[data-product-import-id="'+item.id+'"] td.publish_state span').removeClass('label-warning').addClass('label-success');
    }
    $('#product_import_data tr[data-product-import-id="'+item.id+'"] td.actions').html('<a name="View" class="btn btn-primary btn-sm icon-link with-tip action-eye-open no-text" target="_blank" href="/products/'+item.product_id+'"><span class="icon icon-eye-open"></span> </a> <a target="_blank" data-action="edit" class="btn btn-primary btn-sm icon-link with-tip action-edit no-text" title="Edit" href="/admin/products/'+item.product_id+'/edit"><span class="icon icon-edit"></span> </a>');
  }

  function import_products(product_import_id) {
    var source = new EventSource(product_import_id+'/import');
    source.addEventListener('update', function(e){
      if (e.data.match(/^END/)) {
        source.close();
        import_status = e.data.split(':')[1]
        if (import_status == 'complete') {
          $('#btn-import').hide();
          $('div[data-hook="buttons"] span.or').hide();
          $('div[data-hook="buttons"] a.btn-default').html('<span class="icon icon-remove"></span> Back');
        }
        return;
      }
      item = JSON.parse(e.data);
      update_row(item)
    });
  }

  $(function(){
    $('#btn-import').click(function(event){
      event.preventDefault();
      import_products(<%= @product_import.id %>);
    });
  });
</script>


<div id="product-import-data-wrapper">
  <table class="table" id='product_import_data' data-hook>
    <thead>
      <th class="id"><%= Spree.t(:id) %></th>
      <th class="product_id"><%= Spree.t(:product_id) %></th>
      <th class="sku"><%= Spree.t(:sku) %></th>
      <th class="state"><%= Spree.t(:state) %></th>
      <th class="name"><%= Spree.t(:name) %></th>
      <th class="primary_category"><%= Spree.t(:primary_category) %></th>
      <!--<th class="secondary_category"><%#= Spree.t(:secondary_category) %></th>-->
      <th class="brand"><%= Spree.t(:brand) %></th>
      <th class="collection"><%= Spree.t(:collection) %></th>
      <th class="publish_state"><%= Spree.t(:publish_state) %></th>
      <th class="actions"></th>
    </thead>

    <tbody>
      <% @item_display_data.each do |item| %>
          <tr data-product-import-id="<%= item['id'] %>">
            <td class="id"><%= item['id'] %></td>
            <td class="product_id"><% unless item['product_id'].nil? %><%= item['product_id'] %><% end %></td>
            <td class="sku"><%= item['sku'] %></td>
            <td class="state"><span class="label label-<%= item['state_label'] %>"><%= item['state'] %></span></td>
            <td class="name"><%= item['name'] %></td>
            <td class="primary_category"><%= item['primary_category'] %></td>
            <!--<td class="secondary_category"><%#= item['secondary_category'] %></td>-->
            <td class="brand"><%= item['brand'] %></td>
            <td class="collection"><%= item['collection'] %></td>
            <td class="publish_state"><span class="label label-<%= item['publish_state_label'] %>"><%= item['publish_state'] %></span></td>
            <td class="actions">
              <% unless item['product_id'].nil? %>
                <%= link_to_with_icon('eye-open', nil, product_url(item['product_id']), { :name => 'View', :no_text => true, :class => 'btn btn-primary btn-sm', :target => '_blank' }) %>
                <%= link_to_edit_url(edit_admin_product_url(item['product_id']), { :no_text => true, :target => '_blank' }) %>
              <% end %>
            </td>
          </tr>
      <% end %>
    </tbody>
  </table>
</div>

<div class="form-actions" data-hook="buttons">
  <% unless @product_import.state == 'complete' %>
    <%= button_link_to Spree.t('import'), '', { icon: 'ok', class: 'btn btn-success', id: 'btn-import' } %>
    <span class="or"><%= Spree.t(:or) %></span>
  <% end %>
  <% if @product_import.state == 'complete' %>
    <%= button_link_to Spree.t('actions.back'), admin_product_imports_url, :icon => 'remove' %>
  <% else %>
      <%= button_link_to Spree.t('actions.cancel'), admin_product_imports_url, :icon => 'remove' %>
  <% end %>
</div>
